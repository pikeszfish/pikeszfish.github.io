<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="用 shell 来实现 CNI plugin(bridge)"/>




  <meta name="keywords" content="k8s docker shell bash, Pike's website" />










  <link rel="alternate" href="/atom.xml" title="Pike's website">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://page.pikeszfish.me/2018/01/26/write-cni-plugin-with-shell/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  


  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-100851635-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> 用 shell 来实现 CNI plugin(bridge) - Pike's website </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Pike's website</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Pike's website</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          用 shell 来实现 CNI plugin(bridge)
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-01-26
        </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Why"><span class="toc-text">Why?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How"><span class="toc-text">How?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requirements"><span class="toc-text">requirements</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#common"><span class="toc-text">common</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bridge"><span class="toc-text">Bridge</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Start"><span class="toc-text">Start</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Env-and-stdin"><span class="toc-text">Env and stdin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#check-config-检查-stdin-的配置"><span class="toc-text">check_config/检查 stdin 的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setup-bridge-创建并设置网桥"><span class="toc-text">setup_bridge/创建并设置网桥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setup-netns-设置netns"><span class="toc-text">setup_netns/设置netns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generate-veth-peer-name-随机-veth-name"><span class="toc-text">generate_veth_peer_name/随机 veth name</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setup-veth-创建并设置-veth-peer"><span class="toc-text">setup_veth/创建并设置 veth peer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exec-ipam-执行-ipam-的二进制文件-获取-IP"><span class="toc-text">exec_ipam/执行 ipam 的二进制文件, 获取 IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-container-veth-根据-IPAM-的结果配置容器内的-veth"><span class="toc-text">config_container_veth/根据 IPAM 的结果配置容器内的 veth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-gateway-配置到-br0-的默认路由"><span class="toc-text">config_gateway/配置到 br0 的默认路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-ip-masq-配置-iptables-NAT-表"><span class="toc-text">config_ip_masq/配置 iptables NAT 表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Talk-is-cheap-show-me-the-code"><span class="toc-text">Talk is cheap, show me the code.</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview"><span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-configuration"><span class="toc-text">Example configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Network-configuration-reference"><span class="toc-text">Network configuration reference</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <blockquote>
<p>试试用 shell 脚本来实现一个 CNI(bridge).</p>
</blockquote>
<a id="more"></a>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h2><ul>
<li>好玩</li>
<li>k8s bridge CNI 的设计非常地通用和简单</li>
<li>不用编译, 随时 debug!</li>
</ul>
<h2 id="How"><a href="#How" class="headerlink" title="How?"></a>How?</h2><p>使用 Linux 下的命令行工具, 来实现官方实现下的 bridge 插件的(大部分)功能.</p>
<h2 id="requirements"><a href="#requirements" class="headerlink" title="requirements"></a>requirements</h2><h3 id="common"><a href="#common" class="headerlink" title="common"></a>common</h3><ul>
<li>bash - 执行</li>
<li>ip - 大部分对网络的操作都使用了该命令</li>
<li>jq - 命令行解析 json, 似乎没什么选择…</li>
<li>ln - 软链接 netns 文件</li>
<li>arping - 给容器 IP 发送免费的 arp</li>
</ul>
<h3 id="Bridge"><a href="#Bridge" class="headerlink" title="Bridge"></a>Bridge</h3><ul>
<li>brctl - 仅仅用到了 <code>brctl hairpin &lt;bridge&gt; &lt;port&gt; {on|off}</code>. <code>yum(apt) install bridge-utils</code>. 实现发卡弯模式</li>
</ul>
<h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p>脚本实现和 golang 实现差不多, 主要分为 <code>command_add</code> / <code>command_del</code> / <code>command_version</code>. 下面主要仅仅介绍 <code>command_add</code> 的实现过程:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">command_add</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IS_DEFAULT_GATEWAY&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        IS_GATEWAY=<span class="string">"true"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查配置, 主要是混杂模式和发卡弯模式不能同时开启</span></span><br><span class="line">    check_config</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果没有 br0, 则创建</span></span><br><span class="line">    setup_bridge</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将类似 /proc/49875/ns/net 建立软链接到 /var/run/netns 下, 给 ip 命令使用</span></span><br><span class="line">    setup_netns</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 随机的 veth 名称</span></span><br><span class="line">    host_veth_name=<span class="string">"<span class="variable">$&#123;VETH_PREFIX&#125;</span>`cat /dev/urandom | tr -cd 'a-f0-9' | head -c 8`"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在容器 netns 中创建 veth(因为容器一侧的永远叫 eth0, 不能在主机的 netns 中创建)</span></span><br><span class="line">    setup_veth <span class="variable">$&#123;host_veth_name&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据 IPAM 获取 IP, 结果放在 IPAM_RESULT 中</span></span><br><span class="line">    exec_ipam</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO, 检查结果是否格式正确</span></span><br><span class="line">    check_ipam_result</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给容器内的 eth0 配置 IP/route, 并发送免费 arp</span></span><br><span class="line">    config_container_veth</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IS_GATEWAY&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        config_gateway</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO IP MASQ</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IP_MASQ&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        config_ip_masq</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输到 stderr 的可以在 kubelet 日志中看到</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="variable">$&#123;IPAM_RESULT&#125;</span> &gt;&amp;2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出结果到 stdin</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="variable">$&#123;IPAM_RESULT&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明:</p>
<ol>
<li>从 env 中获取 kubelet 需要 CNI 的参数, 从 stdin 中读取 CNI 的配置</li>
<li>如果 bridge 不存在则创建</li>
<li>需要给 netns 创建软连接到 /var/run/netns, 不然就需要 nsenter 来进入容器的 namespace</li>
<li>在容器的 netns 下创建 veth, 因为给容器的 peer 都叫 eth0, 所以不能在主机的 netns 下创建, 并将主机侧的 veth 移出, 连接到 bridge</li>
<li>从 .ipam.type 执行得到 IP/Route/DNS 等信息, 给容器侧的 eth0 配置</li>
<li>可选地配置 bridge 的地址为网关, 以及配置 iptables 的 MASQ</li>
<li>输出结果到 stdout</li>
</ol>
<h3 id="Env-and-stdin"><a href="#Env-and-stdin" class="headerlink" title="Env and stdin"></a>Env and stdin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNI.spec 规定的环境变量</span></span><br><span class="line">CNI_COMMAND=<span class="variable">$&#123;CNI_COMMAND:-"VERSION"&#125;</span></span><br><span class="line">CNI_CONTAINERID=<span class="variable">$&#123;CNI_CONTAINERID:-""&#125;</span></span><br><span class="line">CNI_NETNS=<span class="variable">$&#123;CNI_NETNS:-""&#125;</span></span><br><span class="line">CNI_IFNAME=<span class="variable">$&#123;CNI_IFNAME:-""&#125;</span></span><br><span class="line">CNI_ARGS=<span class="variable">$&#123;CNI_ARGS:-""&#125;</span></span><br><span class="line">CNI_PATH=<span class="variable">$&#123;CNI_PATH:-""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 stdin 获取配置. 参考</span></span><br><span class="line"><span class="comment"># https://github.com/containernetworking/plugins/blob/master/plugins/main/bridge/README.md</span></span><br><span class="line">INPUT=`cat -`</span><br><span class="line">BRIDGE_NAME=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.bridge'</span>`</span><br><span class="line">IS_GATEWAY=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.isGateway'</span>`</span><br><span class="line">IS_DEFAULT_GATEWAY=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.isDefaultGateway'</span>`</span><br><span class="line">FORCE_ADDRESS=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.forceAddress'</span>`</span><br><span class="line">IP_MASQ=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.ipMasq'</span>`</span><br><span class="line">HAIRPIN_MODE=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.hairpinMode'</span>`</span><br><span class="line">PROMISC_MODE=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.promiscMode'</span>`</span><br><span class="line">MTU=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.mtu'</span>`</span><br><span class="line">IPAM_TYPE=`<span class="built_in">echo</span> <span class="variable">$INPUT</span> | jq -r <span class="string">'.ipam.type'</span>`</span><br></pre></td></tr></table></figure>
<h3 id="check-config-检查-stdin-的配置"><a href="#check-config-检查-stdin-的配置" class="headerlink" title="check_config/检查 stdin 的配置"></a>check_config/检查 stdin 的配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主要是 混杂模式和发卡弯模式不能同时开启</span></span><br><span class="line"><span class="function"><span class="title">check_config</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;PROMISC_MODE&#125;</span>"</span> == <span class="string">"true"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$&#123;HAIRPIN_MODE&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        Fatal <span class="string">"cannot set hairpin mode and promiscous mode at the same time."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setup-bridge-创建并设置网桥"><a href="#setup-bridge-创建并设置网桥" class="headerlink" title="setup_bridge/创建并设置网桥"></a>setup_bridge/创建并设置网桥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># env: $&#123;BRIDGE_NAME&#125; $&#123;MTU&#125; $&#123;PROMISC_MODE&#125;</span></span><br><span class="line"><span class="function"><span class="title">setup_bridge</span></span>() &#123;</span><br><span class="line">    <span class="comment"># test exist</span></span><br><span class="line">    ip_link=`ip link show <span class="variable">$&#123;BRIDGE_NAME&#125;</span>`</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> </span><br><span class="line">        ip link add <span class="variable">$&#123;BRIDGE_NAME&#125;</span> mtu <span class="variable">$&#123;MTU&#125;</span> txqueuelen -1 <span class="built_in">type</span> bridge</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据配置是否打开混杂模式</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;PROMISC_MODE&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        ip link <span class="built_in">set</span> dev <span class="variable">$&#123;BRIDGE_NAME&#125;</span> promisc on</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ip link <span class="built_in">set</span> dev <span class="variable">$&#123;BRIDGE_NAME&#125;</span> promisc off</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setup-netns-设置netns"><a href="#setup-netns-设置netns" class="headerlink" title="setup_netns/设置netns"></a>setup_netns/设置netns</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主要是因为 ip 读取的 netns 是位于 /var/run/netns 下.</span></span><br><span class="line"><span class="comment"># 这里创建了以 $&#123;CNI_CONTAINERID&#125; 为名的 netns</span></span><br><span class="line"><span class="function"><span class="title">setup_netns</span></span>() &#123;</span><br><span class="line">    mkdir -p /var/run/netns/</span><br><span class="line">    ln -sfT <span class="variable">$&#123;CNI_NETNS&#125;</span> /var/run/netns/<span class="variable">$&#123;CNI_CONTAINERID&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cleanup_netns</span></span>() &#123;</span><br><span class="line">    rm -rf /var/run/netns/<span class="variable">$&#123;CNI_CONTAINERID&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="generate-veth-peer-name-随机-veth-name"><a href="#generate-veth-peer-name-随机-veth-name" class="headerlink" title="generate_veth_peer_name/随机 veth name"></a>generate_veth_peer_name/随机 veth name</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">generate_veth_peer_name</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;VETH_PREFIX&#125;</span>`cat /dev/urandom | tr -cd 'a-f0-9' | head -c 8`"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setup-veth-创建并设置-veth-peer"><a href="#setup-veth-创建并设置-veth-peer" class="headerlink" title="setup_veth/创建并设置 veth peer"></a>setup_veth/创建并设置 veth peer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># env: $&#123;CNI_IFNAME&#125;</span></span><br><span class="line"><span class="comment"># arg: $host_veth_name</span></span><br><span class="line"><span class="function"><span class="title">setup_veth</span></span>() &#123;</span><br><span class="line">    host_veth_name=<span class="variable">$&#123;1&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在 $&#123;CNI_CONTAINERID&#125; 的 netns 下创建 veth. 因为容器内的 veth name 都是 eth0, 所以不能都在 host netns 下创建.</span></span><br><span class="line">    ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">        ip link add \</span><br><span class="line">            dev <span class="variable">$&#123;host_veth_name&#125;</span> up \</span><br><span class="line">            mtu <span class="variable">$&#123;MTU&#125;</span> \</span><br><span class="line">            <span class="built_in">type</span> veth \</span><br><span class="line">            peer name <span class="variable">$&#123;CNI_IFNAME&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将 $&#123;host_veth_name&#125; 移到 host 一侧的 netns</span></span><br><span class="line">    ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">        ip link <span class="built_in">set</span> dev <span class="variable">$&#123;host_veth_name&#125;</span> netns 1</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动 host 侧的 veth</span></span><br><span class="line">    ip link <span class="built_in">set</span> <span class="variable">$&#123;host_veth_name&#125;</span> up</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将 host 侧的 veth 连接到 br0 网桥</span></span><br><span class="line">    <span class="comment"># ==: brctl addif $&#123;BRIDGE_NAME&#125; $&#123;host_veth_name&#125;</span></span><br><span class="line">    ip link <span class="built_in">set</span> <span class="variable">$&#123;host_veth_name&#125;</span> master <span class="variable">$&#123;BRIDGE_NAME&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 选择是否配置发卡弯模式</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;HAIRPIN_MODE&#125;</span>"</span> == <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">        brctl hairpin <span class="variable">$&#123;BRIDGE_NAME&#125;</span> <span class="variable">$&#123;host_veth_name&#125;</span> on</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="exec-ipam-执行-ipam-的二进制文件-获取-IP"><a href="#exec-ipam-执行-ipam-的二进制文件-获取-IP" class="headerlink" title="exec_ipam/执行 ipam 的二进制文件, 获取 IP"></a>exec_ipam/执行 ipam 的二进制文件, 获取 IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">exec_ipam</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> `<span class="built_in">echo</span> <span class="variable">$&#123;CNI_PATH&#125;</span> | sed <span class="string">"s/:/ /g"</span>`; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">"<span class="variable">$&#123;p&#125;</span>/<span class="variable">$&#123;IPAM_TYPE&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            IPAM_RESULT=`<span class="built_in">echo</span> -e <span class="variable">$&#123;INPUT&#125;</span> | <span class="variable">$&#123;p&#125;</span>/<span class="variable">$&#123;IPAM_TYPE&#125;</span>`</span><br><span class="line">            <span class="built_in">return</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="config-container-veth-根据-IPAM-的结果配置容器内的-veth"><a href="#config-container-veth-根据-IPAM-的结果配置容器内的-veth" class="headerlink" title="config_container_veth/根据 IPAM 的结果配置容器内的 veth"></a>config_container_veth/根据 IPAM 的结果配置容器内的 veth</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># env: $&#123;CNI_IFNAME&#125; $&#123;IPAM_RESULT&#125;</span></span><br><span class="line"><span class="function"><span class="title">config_container_veth</span></span>() &#123;</span><br><span class="line">    <span class="comment"># set up</span></span><br><span class="line">    ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">        ip link <span class="built_in">set</span> <span class="variable">$&#123;CNI_IFNAME&#125;</span> up</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ip: &#123;"version":"4","address":"192.168.88.59/16","gateway":"192.168.1.1"&#125;</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> `<span class="built_in">echo</span> -e <span class="variable">$&#123;IPAM_RESULT&#125;</span> | jq -r --indent 0 <span class="string">'.ips[]'</span>`; <span class="keyword">do</span></span><br><span class="line">        version=`<span class="built_in">echo</span> <span class="variable">$&#123;ip&#125;</span> | jq -r <span class="string">'.version'</span>`</span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;version&#125;</span>"</span> != <span class="string">"4"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        address=`<span class="built_in">echo</span> <span class="variable">$&#123;ip&#125;</span> | jq -r <span class="string">'.address'</span>`</span><br><span class="line">        gateway=`<span class="built_in">echo</span> <span class="variable">$&#123;ip&#125;</span> | jq -r <span class="string">'.gateway'</span>`</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add ip address</span></span><br><span class="line">        ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">            ip addr add <span class="variable">$&#123;address&#125;</span> dev <span class="variable">$&#123;CNI_IFNAME&#125;</span> 1&gt;&amp;2</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># route: &#123;"gw":"192.168.1.1","dst":"0.0.0.0/0"&#125;</span></span><br><span class="line">    <span class="keyword">for</span> route <span class="keyword">in</span> `<span class="built_in">echo</span> -e <span class="variable">$&#123;IPAM_RESULT&#125;</span> | jq -r --indent 0 <span class="string">'.routes[]'</span>`; <span class="keyword">do</span></span><br><span class="line">        gw=`<span class="built_in">echo</span> <span class="variable">$&#123;route&#125;</span> | jq -r <span class="string">'.gw'</span>`</span><br><span class="line">        dst=`<span class="built_in">echo</span> <span class="variable">$&#123;route&#125;</span> | jq -r <span class="string">'.dst'</span>`</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add route</span></span><br><span class="line">        ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">            ip route add <span class="variable">$&#123;dst&#125;</span> via <span class="variable">$&#123;gw&#125;</span> 1&gt;&amp;2</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># arp</span></span><br><span class="line">    <span class="keyword">for</span> ip <span class="keyword">in</span> `<span class="built_in">echo</span> -e <span class="variable">$&#123;IPAM_RESULT&#125;</span> | jq -r --indent 0 <span class="string">'.ips[]'</span>`; <span class="keyword">do</span></span><br><span class="line">        version=`<span class="built_in">echo</span> <span class="variable">$&#123;ip&#125;</span> | jq -r <span class="string">'.version'</span>`</span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;version&#125;</span>"</span> != <span class="string">"4"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        address=`<span class="built_in">echo</span> <span class="variable">$&#123;ip&#125;</span> | jq -r <span class="string">'.address'</span>`</span><br><span class="line"></span><br><span class="line">        <span class="comment"># sends an gratuitous arp. $&#123;address%/*&#125; for 192.168.1.100/16 -&gt; 192.168.1.100</span></span><br><span class="line">        ip netns <span class="built_in">exec</span> <span class="variable">$&#123;CNI_CONTAINERID&#125;</span> \</span><br><span class="line">            arping -c 4 -A -I <span class="variable">$&#123;CNI_IFNAME&#125;</span> <span class="variable">$&#123;address%/*&#125;</span> 1&gt;&amp;2</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="config-gateway-配置到-br0-的默认路由"><a href="#config-gateway-配置到-br0-的默认路由" class="headerlink" title="config_gateway/配置到 br0 的默认路由"></a>config_gateway/配置到 br0 的默认路由</h3><p>该部分逻辑在 ipam 返回所有路由信息的情况下, 是不需要的…所以留了 TODO.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">config_gateway</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"TODO"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="config-ip-masq-配置-iptables-NAT-表"><a href="#config-ip-masq-配置-iptables-NAT-表" class="headerlink" title="config_ip_masq/配置 iptables NAT 表"></a>config_ip_masq/配置 iptables NAT 表</h3><p>当配置和主机同网段 IP 时候, 也不需要该部分配置…也留个 TODO 吧.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">config_ip_masq</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"TODO"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Talk-is-cheap-show-me-the-code"><a href="#Talk-is-cheap-show-me-the-code" class="headerlink" title="Talk is cheap, show me the code."></a>Talk is cheap, show me the code.</h2><p><a href="https://github.com/pikeszfish/shell-plugin-for-cni" target="_blank" rel="noopener">pikeszfish/shell-plugin-for-cni</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://github.com/containernetworking/plugins/blob/master/plugins/main/bridge/README.md" target="_blank" rel="noopener">containernetworking/plugins/plugins/main/bridge/README.md</a></p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>With bridge plugin, all containers (on the same host) are plugged into a bridge (virtual switch) that resides in the host network namespace.<br>The containers receive one end of the veth pair with the other end connected to the bridge.<br>An IP address is only assigned to one end of the veth pair – one residing in the container.<br>The bridge itself can also be assigned an IP address, turning it into a gateway for the containers.<br>Alternatively, the bridge can function purely in L2 mode and would need to be bridged to the host network interface (if other than container-to-container communication on the same host is desired).</p>
<p>The network configuration specifies the name of the bridge to be used.<br>If the bridge is missing, the plugin will create one on first use and, if gateway mode is used, assign it an IP that was returned by IPAM plugin via the gateway field.</p>
<h3 id="Example-configuration"><a href="#Example-configuration" class="headerlink" title="Example configuration"></a>Example configuration</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;bridge&quot;: &quot;mynet0&quot;,</span><br><span class="line">    &quot;isDefaultGateway&quot;: true,</span><br><span class="line">    &quot;forceAddress&quot;: false,</span><br><span class="line">    &quot;ipMasq&quot;: true,</span><br><span class="line">    &quot;hairpinMode&quot;: true,</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;10.10.0.0/16&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Network-configuration-reference"><a href="#Network-configuration-reference" class="headerlink" title="Network configuration reference"></a>Network configuration reference</h3><ul>
<li><code>name</code> (string, required): the name of the network.</li>
<li><code>type</code> (string, required): “bridge”.</li>
<li><code>bridge</code> (string, optional): name of the bridge to use/create. Defaults to “cni0”.</li>
<li><code>isGateway</code> (boolean, optional): assign an IP address to the bridge. Defaults to false.</li>
<li><code>isDefaultGateway</code> (boolean, optional): Sets isGateway to true and makes the assigned IP the default route. Defaults to false.</li>
<li><code>forceAddress</code> (boolean, optional): Indicates if a new IP address should be set if the previous value has been changed. Defaults to false.</li>
<li><code>ipMasq</code> (boolean, optional): set up IP Masquerade on the host for traffic originating from this network and destined outside of it. Defaults to false.</li>
<li><code>mtu</code> (integer, optional): explicitly set MTU to the specified value. Defaults to the value chosen by the kernel.</li>
<li><code>hairpinMode</code> (boolean, optional): set hairpin mode for interfaces on the bridge. Defaults to false.</li>
<li><code>ipam</code> (dictionary, required): IPAM configuration to be used for this network.</li>
<li><code>promiscMode</code> (boolean, optional): set promiscuous mode on the bridge. Defaults to false.</li>
</ul>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://page.pikeszfish.me">Pike.SZ.fish</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://page.pikeszfish.me/2018/01/26/write-cni-plugin-with-shell/">https://page.pikeszfish.me/2018/01/26/write-cni-plugin-with-shell/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/k8s-docker-shell-bash/">k8s docker shell bash</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/01/31/digital-demons/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">[转]数字魔障</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2018/01/24/finally-it-comes-to-kube-router/">
        <span class="next-text nav-default">终于 kube-router</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:pikeszfish@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/pikeszfish" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/pikeszfish" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/u/2173563292" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Pike.SZ.fish</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://page.pikeszfish.me/2018/01/26/write-cni-plugin-with-shell/';
        this.page.identifier = '2018/01/26/write-cni-plugin-with-shell/';
        this.page.title = '用 shell 来实现 CNI plugin(bridge)';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//Pike.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
